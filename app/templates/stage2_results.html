{% extends "base.html" %}

{% block app_content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-success text-white shadow-lg">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h1 class="h2 mb-0">
                                <i class="fas fa-coins me-2"></i>{{ title }}
                            </h1>
                            {% if report.date_range %}
                                <p class="mb-0 opacity-75">{{ report.date_range }}</p>
                            {% else %}
                                <p class="mb-0 opacity-75">All Time Data Analysis</p>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-pie fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Summary Cards -->
    <div class="row mb-4">
        {% set key_metrics = {
            'Total Deposits': (report.calculations.get('M2p Deposit', 0) + report.calculations.get('Settlement Deposit', 0) + report.calculations.get('CRM Deposit Total', 0)),
            'Total Withdrawals': (report.calculations.get('M2p Withdrawal', 0) + report.calculations.get('Settlement Withdrawal', 0) + report.calculations.get('CRM Withdraw Total', 0)),
            'Total Rebate': report.calculations.get('Total Rebate', 0),
            'Net Flow': 0
        } %}
        {% set _ = key_metrics.update({'Net Flow': key_metrics['Total Deposits'] - key_metrics['Total Withdrawals']}) %}
        
        {% for metric, value in key_metrics.items() %}
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow h-100">
                <div class="card-body text-center">
                    <div class="text-{% if value >= 0 %}success{% else %}danger{% endif %} mb-2">
                        <i class="fas fa-{% if metric == 'Total Deposits' %}arrow-down{% elif metric == 'Total Withdrawals' %}arrow-up{% elif metric == 'Total Rebate' %}gift{% else %}exchange-alt{% endif %} fa-2x"></i>
                    </div>
                    <h5 class="card-title">{{ metric }}</h5>
                    <h3 class="text-{% if value >= 0 %}success{% else %}danger{% endif %}">${{ "{:,.2f}".format(value) }}</h3>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Financial Analysis Charts
                    </h5>
                </div>
                <div class="card-body">
                    {% if chart_data %}
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <div id="volume-chart"></div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div id="fee-chart"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div id="summary-chart"></div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                            <p>No data available for chart generation</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Financial Report -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Detailed Financial Report
                    </h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportToCSV()">
                            <i class="fas fa-download me-1"></i>Export CSV
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="printReport()">
                            <i class="fas fa-print me-1"></i>Print
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="financial-report-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Category</th>
                                    <th class="text-end">Amount (USD)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in report.report_data %}
                                    {% if row[0] and row[1] %}
                                        <tr{% if row[0] == 'Date Range' %} class="table-info"{% endif %}>
                                            <td>
                                                {% if row[0] in ['M2p Deposit', 'Settlement Deposit', 'CRM Deposit Total'] %}
                                                    <i class="fas fa-arrow-down text-success me-2"></i>
                                                {% elif row[0] in ['M2p Withdrawal', 'Settlement Withdrawal', 'CRM Withdraw Total'] %}
                                                    <i class="fas fa-arrow-up text-danger me-2"></i>
                                                {% elif 'Fee' in row[0] %}
                                                    <i class="fas fa-coins text-warning me-2"></i>
                                                {% elif 'Rebate' in row[0] %}
                                                    <i class="fas fa-gift text-info me-2"></i>
                                                {% endif %}
                                                {{ row[0] }}
                                            </td>
                                            <td class="text-end">
                                                {% if row[0] != 'Date Range' %}
                                                    ${{ row[1] }}
                                                {% else %}
                                                    {{ row[1] }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
        <div class="col-12 text-center">
            <div class="btn-group" role="group">
                <a href="{{ url_for('main.generate_stage2_report') }}" class="btn btn-primary">
                    <i class="fas fa-redo me-1"></i>Generate New Report
                </a>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-home me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Plotly Charts -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
{% if chart_data %}
// Volume Comparison Chart
const volumeData = {{ chart_data.volumes | tojson }};
const volumeTrace = {
    x: Object.keys(volumeData),
    y: Object.values(volumeData),
    type: 'bar',
    marker: {
        color: ['#4CAF50', '#4CAF50', '#4CAF50', '#FF5722', '#FF5722', '#FF5722']
    }
};
Plotly.newPlot('volume-chart', [volumeTrace], {
    title: 'Transaction Volumes by Category',
    yaxis: { title: 'Amount (USD)' }
});

// Fee Distribution Chart
const feeData = {{ chart_data.fees | tojson }};
const feeTrace = {
    labels: Object.keys(feeData),
    values: Object.values(feeData),
    type: 'pie',
    marker: {
        colors: ['#FF9800', '#F44336', '#2196F3']
    }
};
Plotly.newPlot('fee-chart', [feeTrace], {
    title: 'Fee Distribution'
});

// Summary Chart
const summaryData = {{ chart_data.calculations | tojson }};
const summaryCategories = ['M2p Deposit', 'Settlement Deposit', 'CRM Deposit Total', 'M2p Withdrawal', 'Settlement Withdrawal', 'CRM Withdraw Total'];
const summaryValues = summaryCategories.map(cat => summaryData[cat] || 0);
const summaryColors = summaryCategories.map(cat => cat.includes('Deposit') ? '#4CAF50' : '#FF5722');

const summaryTrace = {
    x: summaryCategories,
    y: summaryValues,
    type: 'bar',
    marker: { color: summaryColors }
};
Plotly.newPlot('summary-chart', [summaryTrace], {
    title: 'Complete Financial Overview',
    yaxis: { title: 'Amount (USD)' }
});
{% endif %}

// Export functionality
function exportToCSV() {
    const table = document.getElementById('financial-report-table');
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = [], cols = rows[i].querySelectorAll('td, th');
        for (let j = 0; j < cols.length; j++) {
            row.push(cols[j].innerText);
        }
        csv.push(row.join(','));
    }
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'financial_report_{{ start_date.strftime("%Y%m%d") if start_date else "all_time" }}.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function printReport() {
    window.print();
}
</script>

<style>
.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.card {
    transition: all 0.3s ease;
    border-radius: 10px;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.opacity-75 { opacity: 0.75; }
.opacity-50 { opacity: 0.5; }

@media print {
    .btn, .card-header button {
        display: none;
    }
    
    .card {
        border: 1px solid #dee2e6 !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}