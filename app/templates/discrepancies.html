{% extends "base.html" %}

{% block app_content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-warning text-dark shadow-lg">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <h1 class="h2 mb-0">
                                <i class="fas fa-search me-2"></i>{{ title }}
                            </h1>
                            {% if start_date and end_date %}
                                <p class="mb-0">From {{ start_date.strftime('%Y-%m-%d') }} to {{ end_date.strftime('%Y-%m-%d') }}</p>
                            {% else %}
                                <p class="mb-0">All Time Analysis</p>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card border-danger shadow h-100">
                <div class="card-body text-center">
                    <div class="text-danger mb-2">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                    </div>
                    <h5 class="card-title">Total Discrepancies</h5>
                    <h3 class="text-danger">{{ discrepancies.total_discrepancies }}</h3>
                    <p class="card-text text-muted">Records requiring attention</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="card border-info shadow h-100">
                <div class="card-body text-center">
                    <div class="text-info mb-2">
                        <i class="fas fa-balance-scale fa-2x"></i>
                    </div>
                    <h5 class="card-title">Analysis Status</h5>
                    <h3 class="text-info">
                        {% if discrepancies.total_discrepancies == 0 %}
                            ✓ Clean
                        {% else %}
                            Review Required
                        {% endif %}
                    </h3>
                    <p class="card-text text-muted">Data integrity check</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="card border-success shadow h-100">
                <div class="card-body text-center">
                    <div class="text-success mb-2">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                    <h5 class="card-title">Comparison Method</h5>
                    <h3 class="text-success">Smart Match</h3>
                    <p class="card-text text-muted">Time window: ±3.5 hours<br>Amount tolerance: ±$1</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    {% if discrepancies.total_discrepancies > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info border-0 shadow-sm">
                <div class="d-flex">
                    <i class="fas fa-info-circle me-3 mt-1"></i>
                    <div>
                        <h6 class="mb-2">How to use this analysis:</h6>
                        <ul class="mb-0 small">
                            <li><strong>Review each discrepancy:</strong> Check if the transaction is legitimate</li>
                            <li><strong>Mark as confirmed:</strong> Use the dropdown to confirm legitimate transactions</li>
                            <li><strong>Investigate unmatched:</strong> Look for data entry errors or missing records</li>
                            <li><strong>TopChange exclusion:</strong> TopChange transactions are automatically excluded from mismatch analysis</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Discrepancies Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Deposit Discrepancies
                        {% if discrepancies.total_discrepancies > 0 %}
                            <span class="badge bg-warning text-dark ms-2">{{ discrepancies.total_discrepancies }} issues</span>
                        {% else %}
                            <span class="badge bg-success ms-2">All Clear</span>
                        {% endif %}
                    </h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportDiscrepancies()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshAnalysis()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if discrepancies.total_discrepancies > 0 %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="discrepancies-table">
                                <thead class="table-dark">
                                    <tr>
                                        {% for header in discrepancies.headers %}
                                            {% if header != 'ID' %}
                                                <th>{{ header }}</th>
                                            {% endif %}
                                        {% endfor %}
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in discrepancies.discrepancies %}
                                        <tr id="row-{{ loop.index }}" data-id="{{ row[-1] }}">
                                            {% for i in range(discrepancies.headers|length - 1) %}
                                                <td>
                                                    {% if i == 0 %}
                                                        {% if row[i] == 'CRM Deposit' %}
                                                            <span class="badge bg-info">{{ row[i] }}</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">{{ row[i] }}</span>
                                                        {% endif %}
                                                    {% elif i == 4 %}
                                                        <strong>${{ row[i] }}</strong>
                                                    {% elif i == 6 %}
                                                        <select class="form-select form-select-sm" onchange="updateConfirmation('{{ row[-1] }}', this.value)">
                                                            <option value="N"{% if row[i] == 'N' %} selected{% endif %}>No</option>
                                                            <option value="Y"{% if row[i] == 'Y' %} selected{% endif %}>Yes</option>
                                                        </select>
                                                    {% else %}
                                                        {{ row[i] }}
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-success" onclick="markResolved('{{ row[-1] }}')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-outline-info" onclick="investigateRecord('{{ row[-1] }}')">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Bulk Actions -->
                        <div class="mt-3 pt-3 border-top">
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-success btn-sm" onclick="markAllResolved()">
                                    <i class="fas fa-check-double me-1"></i>Mark All as Resolved
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="flagForReview()">
                                    <i class="fas fa-flag me-1"></i>Flag for Manual Review
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                            <h4 class="text-success">No Discrepancies Found</h4>
                            <p class="text-muted">All CRM deposits have been successfully matched with client payment data.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
        <div class="col-12 text-center">
            <div class="btn-group" role="group">
                <a href="{{ url_for('main.generate_stage2_report') }}" class="btn btn-primary">
                    <i class="fas fa-chart-bar me-1"></i>Generate New Report
                </a>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-home me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Update confirmation status
function updateConfirmation(recordId, status) {
    // Here you would typically make an AJAX call to update the database
    console.log(`Updating record ${recordId} to ${status}`);
    
    const row = document.querySelector(`tr[data-id="${recordId}"]`);
    if (status === 'Y') {
        row.classList.add('table-success');
        row.classList.remove('table-danger');
    } else {
        row.classList.remove('table-success');
        row.classList.add('table-danger');
    }
}

// Mark record as resolved
function markResolved(recordId) {
    const row = document.querySelector(`tr[data-id="${recordId}"]`);
    row.style.opacity = '0.5';
    row.querySelector('select').value = 'Y';
    updateConfirmation(recordId, 'Y');
    
    // Show success message
    showToast('Record marked as resolved', 'success');
}

// Investigate record
function investigateRecord(recordId) {
    // This would typically open a modal or navigate to detailed view
    showToast('Investigation mode activated for record: ' + recordId, 'info');
}

// Mark all as resolved
function markAllResolved() {
    if (confirm('Are you sure you want to mark all discrepancies as resolved?')) {
        const rows = document.querySelectorAll('#discrepancies-table tbody tr');
        rows.forEach(row => {
            row.style.opacity = '0.5';
            row.querySelector('select').value = 'Y';
            row.classList.add('table-success');
        });
        showToast('All records marked as resolved', 'success');
    }
}

// Flag for review
function flagForReview() {
    showToast('Records flagged for manual review', 'warning');
}

// Export discrepancies
function exportDiscrepancies() {
    const table = document.getElementById('discrepancies-table');
    if (!table) return;
    
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = [], cols = rows[i].querySelectorAll('td, th');
        for (let j = 0; j < cols.length - 1; j++) { // Exclude actions column
            row.push(cols[j].innerText.replace(/,/g, ';')); // Replace commas to avoid CSV issues
        }
        if (row.length > 0) csv.push(row.join(','));
    }
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'deposit_discrepancies_{{ start_date.strftime("%Y%m%d") if start_date else "all_time" }}.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Refresh analysis
function refreshAnalysis() {
    location.reload();
}

// Toast notification helper
function showToast(message, type = 'info') {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `<i class="fas fa-info-circle me-2"></i>${message}`;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>

<style>
.bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
}

.card {
    transition: all 0.3s ease;
    border-radius: 10px;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.opacity-50 { opacity: 0.5; }

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}
</style>
{% endblock %}